#!/bin/bash
# AEIMS Backup Script
# Backs up database and application files to S3

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/tmp/aeims_backup_$DATE"
APP_DIR="{{ app_directory }}"
DB_NAME="aeims"
DB_USER="aeims_user"
DB_PASS="{{ mysql_aeims_password }}"
S3_BUCKET="aeims-backups-{{ environment }}"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup database
echo "Backing up database..."
mysqldump -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" > "$BACKUP_DIR/database.sql"

# Backup application files (exclude logs and cache)
echo "Backing up application files..."
tar -czf "$BACKUP_DIR/application.tar.gz" \
    --exclude="*.log" \
    --exclude="cache/*" \
    --exclude="tmp/*" \
    -C "$(dirname "$APP_DIR")" \
    "$(basename "$APP_DIR")"

# Upload to S3
echo "Uploading to S3..."
aws s3 cp "$BACKUP_DIR/database.sql" "s3://$S3_BUCKET/database/database_$DATE.sql"
aws s3 cp "$BACKUP_DIR/application.tar.gz" "s3://$S3_BUCKET/application/application_$DATE.tar.gz"

# Cleanup local backup
rm -rf "$BACKUP_DIR"

# Cleanup old S3 backups (keep last 30 days)
aws s3 ls "s3://$S3_BUCKET/database/" | \
    grep -v "$(date +%Y-%m)" | \
    grep -v "$(date -d '1 month ago' +%Y-%m)" | \
    awk '{print $4}' | \
    xargs -I {} aws s3 rm "s3://$S3_BUCKET/database/{}"

aws s3 ls "s3://$S3_BUCKET/application/" | \
    grep -v "$(date +%Y-%m)" | \
    grep -v "$(date -d '1 month ago' +%Y-%m)" | \
    awk '{print $4}' | \
    xargs -I {} aws s3 rm "s3://$S3_BUCKET/application/{}"

echo "Backup completed: $DATE"